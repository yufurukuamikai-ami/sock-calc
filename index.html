<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é´ä¸‹ç·¨ã¿è¨ˆç®—æ©Ÿï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰</title>
  <style>
    :root{--bg:#fafafa;--card:#fff;--text:#222;--muted:#666;--b:#e5e5e5;--r:14px;}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:920px;margin:0 auto;padding:16px;}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
    h1{font-size:22px;margin:0;}
    .badge{display:inline-block;font-size:12px;border:1px solid var(--b);padding:2px 8px;border-radius:999px;color:var(--muted);}
    .card{background:var(--card);border:1px solid var(--b);border-radius:var(--r);padding:14px;box-shadow:0 1px 6px rgba(0,0,0,.04);}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;}
    @media (max-width:720px){.grid{grid-template-columns:1fr;}}
    label{display:block;font-size:13px;color:#333;margin:0 0 6px;}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--b);border-radius:12px;font-size:16px;box-sizing:border-box;background:#fff;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .radio{display:flex;align-items:center;gap:6px;font-size:14px;}
    .radio input{width:auto;}
    .muted{color:var(--muted);font-size:12px;line-height:1.4;}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    button{border:0;border-radius:14px;padding:12px 14px;font-size:16px;font-weight:700;cursor:pointer;}
    .btn{background:#111;color:#fff;}
    .btn2{background:#f3f3f3;color:#111;border:1px solid var(--b);}
    .steps{display:grid;gap:10px;margin-top:12px;}
    .step{border:1px solid var(--b);border-radius:14px;padding:12px;background:#fff;}
    .step h3{margin:0 0 6px;font-size:16px;}
    .big{font-size:18px;font-weight:900;}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;}
    .kpi span{display:inline-block;background:#f6f6f6;border:1px solid var(--b);border-radius:999px;padding:6px 10px;font-size:13px;}
    .hide{display:none;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>é´ä¸‹ç·¨ã¿è¨ˆç®—æ©Ÿï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆï¼‰ <span class="badge" id="versionBadge">v0.4</span></h1>
      <div class="muted">byã‚†ã‚‹ãµãç·¨ã¿ç‰©ä¼š</div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="footLength">è¶³ã®é•·ã•ï¼ˆcmï¼‰</label>
          <input id="footLength" type="number" min="10" max="35" step="0.5" value="24" />
        </div>
        <div>
          <label for="ankleCirc">è¶³é¦–å‘¨ã‚Šï¼ˆcmï¼‰</label>
          <input id="ankleCirc" type="number" min="10" max="40" step="0.5" value="20" />
        </div>
        <div>
          <label for="cuffLength">é•·ã•ï¼ˆå±¥ãå£ï¼‰ï¼ˆcmï¼‰</label>
          <input id="cuffLength" type="number" min="1" max="30" step="0.5" value="6" />
          <div class="muted" style="margin-top:6px;">â€»ã‚´ãƒ ç·¨ã¿éƒ¨åˆ†ã®é•·ã•ï¼ˆãŠå¥½ã¿ã§å¤‰æ›´OKï¼‰</div>
        </div>
        <div>
          <label for="yarnWeight">æ¯›ç³¸ã®å¤ªã•ï¼ˆæ¨™æº–ã‚²ãƒ¼ã‚¸ï¼‰</label>
          <select id="yarnWeight">
            <option value="ultra-fine">è¶…æ¥µç´°ï¼ˆãƒ¬ãƒ¼ã‚¹ç³¸ï¼‰</option>
            <option value="super-fine" selected>æ¥µç´°ï¼ˆé´ä¸‹ç”¨ãªã©ï¼‰</option>
            <option value="fine">åˆç´°</option>
            <option value="light">ä¸­ç´°</option>
            <option value="medium">åˆå¤ª</option>
            <option value="bulky">ä¸¦å¤ª</option>
            <option value="super-bulky">æ¥µå¤ª</option>
            <option value="jumbo">è¶…æ¥µå¤ª</option>
          </select>
          <div class="muted" id="gaugeHint" style="margin-top:6px;"></div>
        </div>
        <div>
          <label for="needleSize">ç·¨ã¿é‡ï¼ˆå·ï¼‰</label>
          <select id="needleSize">
            <option value="0">0å· (2.0mm)</option>
            <option value="1">1å· (2.1mm)</option>
            <option value="2">2å· (2.3mm)</option>
            <option value="2.5" selected>2.5å· (2.5mm)</option>
            <option value="3">3å· (2.7mm)</option>
            <option value="4">4å· (3.0mm)</option>
            <option value="5">5å· (3.3mm)</option>
            <option value="6">6å· (3.6mm)</option>
            <option value="7">7å· (3.9mm)</option>
            <option value="8">8å· (4.2mm)</option>
            <option value="9">9å· (4.5mm)</option>
            <option value="10">10å· (4.8mm)</option>
            <option value="12">12å· (5.4mm)</option>
            <option value="15">15å· (6.6mm)</option>
          </select>
        </div>
        <div>
          <label>é´ä¸‹ã®å½¢</label>
          <div class="row">
            <label class="radio"><input type="radio" name="sockType" value="standard" checked>æ¨™æº–</label>
            <label class="radio"><input type="radio" name="sockType" value="utsubo">ã‚¦ãƒ„ãƒœï¼ˆãƒãƒï¼‹ãƒ€ãƒ–ãƒ«ç›®ï¼‰</label>
          </div>
        </div>
      </div>

      <div id="utsuboSettings" class="card" style="margin-top:12px; display:none;">
        <div class="row" style="justify-content:space-between;">
          <div style="font-weight:800;">ã‚¦ãƒ„ãƒœè¨­å®š</div>
          <div class="muted" id="utsuboAutoHint"></div>
        </div>
        <div class="grid" style="margin-top:10px;">
          <div>
            <label for="utsuboGussetPerSide">ãƒãƒï¼ˆç‰‡å´ï¼‰ç›®æ•°</label>
            <input id="utsuboGussetPerSide" type="number" min="1" max="30" value="5" />
          </div>
          <div>
            <label for="utsuboDoublePerSide">ã‹ã‹ã¨ï¼ˆãƒ€ãƒ–ãƒ«ç›®ï¼‰ç‰‡å´å›æ•°</label>
            <input id="utsuboDoublePerSide" type="number" min="1" max="40" value="8" />
          </div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>ç·¨ã¿æ–¹</label>
        <div class="row">
          <label class="radio"><input type="radio" name="method" value="toe" checked>ã¤ã¾å…ˆã‹ã‚‰</label>
          <label class="radio"><input type="radio" name="method" value="cuff">å±¥ãå£ã‹ã‚‰</label>
        </div>
      </div>

      <div style="margin-top:12px;">
        <label class="radio"><input id="useCustom" type="checkbox"> å®Ÿæ¸¬ã‚²ãƒ¼ã‚¸ã‚’å…¥åŠ›ã™ã‚‹ï¼ˆã‚ˆã‚Šæ­£ç¢ºï¼‰</label>
        <div id="customBox" class="grid hide" style="margin-top:10px;">
          <div>
            <label for="gSt">ã‚²ãƒ¼ã‚¸ 10cm = ç›®æ•°</label>
            <input id="gSt" type="number" min="10" max="60" value="28" />
          </div>
          <div>
            <label for="gRow">ã‚²ãƒ¼ã‚¸ 10cm = æ®µæ•°</label>
            <input id="gRow" type="number" min="10" max="80" value="36" />
          </div>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn" id="calcBtn">ğŸ“Š è¨ˆç®—ã™ã‚‹</button>
        <button class="btn2" id="copyBugBtn" type="button">ğŸ› ä¸å…·åˆå ±å‘Šç”¨ã«ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div class="muted" id="copyMsg" style="margin-top:8px;"></div>
      <div id="errBox" class="box b-gray" style="display:none; margin-top:10px; border-left:6px solid #e11d48;">
        <h3 style="margin:0 0 6px 0; color:#e11d48;">ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ãƒãƒ›ã§è¨ˆç®—ã§ããªã„åŸå› ï¼‰</h3>
        <pre id="errText" style="margin:0; white-space:pre-wrap; word-break:break-word;"></pre>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="kpi" id="summary"></div>
      <div class="steps" id="steps"></div>
      <div class="muted" style="margin-top:10px;">â€»è¨ˆç®—ã¯ç›®å®‰ã§ã™ã€‚ç³¸ãƒ»é‡ãƒ»å¥½ã¿ã§å¾®èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</div>
    </div>
  </div>

<script>
  const VERSION = 'v0.5-mobilefix (2026-01-20)';

  const yarnGauges = {
    'ultra-fine': { stitches: 32, rows: 42, needleRange: '0ã€œ2å·', name:'è¶…æ¥µç´°ï¼ˆãƒ¬ãƒ¼ã‚¹ç³¸ï¼‰' },
    'super-fine': { stitches: 28, rows: 36, needleRange: '1ã€œ3å·', name:'æ¥µç´°ï¼ˆé´ä¸‹ç”¨ãªã©ï¼‰' },
    'fine': { stitches: 24, rows: 32, needleRange: '2ã€œ4å·', name:'åˆç´°' },
    'light': { stitches: 22, rows: 28, needleRange: '3ã€œ5å·', name:'ä¸­ç´°' },
    'medium': { stitches: 20, rows: 26, needleRange: '4ã€œ6å·', name:'åˆå¤ª' },
    'bulky': { stitches: 18, rows: 24, needleRange: '6ã€œ8å·', name:'ä¸¦å¤ª' },
    'super-bulky': { stitches: 14, rows: 20, needleRange: '8ã€œ10å·', name:'æ¥µå¤ª' },
    'jumbo': { stitches: 10, rows: 14, needleRange: '10ã€œ15å·', name:'è¶…æ¥µå¤ª' }
  };

  const $ = (id)=>document.getElementById(id);
  const getRadioValue = (name)=> (document.querySelector(`input[name="${name}"]:checked`)||{}).value;

  function showError(err){
    try{
      const box = $('errBox');
      const txt = $('errText');
      if (!box || !txt) return;
      const msg = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
      box.style.display = 'block';
      txt.textContent = msg;
    } catch(_){}
  }

  function clearError(){
    const box = $('errBox');
    const txt = $('errText');
    if (box) box.style.display = 'none';
    if (txt) txt.textContent = '';
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ã‚‚ç”»é¢ã«å‡ºã™ï¼ˆã‚¹ãƒãƒ›ã§ã€Œç„¡åå¿œã€ã‚’æ½°ã™ï¼‰
  window.addEventListener('error', function(ev){ showError(ev.error || (ev.message + ' @' + ev.filename + ':' + ev.lineno)); });
  window.addEventListener('unhandledrejection', function(ev){ showError(ev.reason || ev); });

  function clampNum(v, min, max){
    if (Number.isNaN(v)) return min;
    return Math.max(min, Math.min(max, v));
  }

  function makeEven(n){
    n = Math.round(n);
    return (n % 2 === 0) ? n : n + 1;
  }

  function suggestUtsuboParams(totalSt){
    const gussetPerSide = Math.max(3, Math.round(totalSt * 0.09));
    const doublePerSide = Math.max(6, Math.round(totalSt * 0.14));
    return { gussetPerSide, doublePerSide };
  }

  function toggleUtsuboSettings(){
    const isUtsubo = getRadioValue('sockType') === 'utsubo';
    $('utsuboSettings').style.display = isUtsubo ? 'block' : 'none';
  }

  function setGaugeHint(){
    const useCustom = $('useCustom').checked;
    const yarnWeight = $('yarnWeight').value;
    const g = yarnGauges[yarnWeight];
    const stitches = useCustom ? clampNum(parseFloat($('gSt').value), 10, 60) : g.stitches;
    const rows = useCustom ? clampNum(parseFloat($('gRow').value), 10, 80) : g.rows;
    $('gaugeHint').textContent = `ã‚²ãƒ¼ã‚¸ï¼š10cm = ${stitches}ç›® Ã— ${rows}æ®µï¼ˆæ¨å¥¨é‡ï¼š${g.needleRange}ï¼‰`;
  }

  function compute(){
    const footLength = clampNum(parseFloat($('footLength').value), 10, 35);
    const ankleCirc = clampNum(parseFloat($('ankleCirc').value), 10, 40);
    const cuffLength = clampNum(parseFloat($('cuffLength').value), 1, 30);

    const yarnWeight = $('yarnWeight').value;
    const useCustom = $('useCustom').checked;
    const method = getRadioValue('method');
    const sockType = getRadioValue('sockType');
    const isUtsubo = sockType === 'utsubo';

    const gStd = yarnGauges[yarnWeight];
    const stitches10 = useCustom ? clampNum(parseFloat($('gSt').value), 10, 60) : gStd.stitches;
    const rows10 = useCustom ? clampNum(parseFloat($('gRow').value), 10, 80) : gStd.rows;

    const stitchesPerCm = stitches10 / 10;
    const rowsPerCm = rows10 / 10;

    // ä½œã‚Šç›®ï¼ˆ4ã®å€æ•°ï¼‰
    const castOn = Math.round(ankleCirc * stitchesPerCm / 4) * 4;

    // ã‚¦ãƒ„ãƒœã¯è¶³é¦–å‘¨ã‚Šã‚’å°‘ã—çµã‚‹æƒ³å®šï¼ˆç›®å®‰ï¼‰
    const utsuboAnkleCirc = isUtsubo ? ankleCirc * 0.7 : ankleCirc;
    const utsuboCastOn = isUtsubo ? Math.round(utsuboAnkleCirc * stitchesPerCm / 4) * 4 : castOn;

    const totalSt = isUtsubo ? utsuboCastOn : castOn;

    // ã¤ã¾å…ˆé–‹å§‹ï¼ˆtoe-upï¼‰ã¯å¶æ•°
    let toeCastOnStart = Math.round(totalSt / 4);
    toeCastOnStart = makeEven(toeCastOnStart);

    // ã‹ã‹ã¨ï¼ˆæ¨™æº–ï¼‰
    const heelStitches = totalSt / 2;
    const heelFlapRows = Math.round(heelStitches);
    const heelTurnRows = Math.round(heelStitches / 3);

    // ç”²ï¼ˆè¶³ã®é•·ã•ã®ç´„2/3ã‚’ç›®å®‰ï¼‰
    const footLength67 = footLength * 0.67;
    const footRows = Math.round(footLength67 * rowsPerCm);
    const footCm = Math.round(footLength67);

    // å±¥ãå£
    const cuffRows = Math.max(1, Math.round(cuffLength * rowsPerCm));
    const cuffCm = Math.max(1, Math.round(cuffRows / rowsPerCm));

    // ã¤ã¾å…ˆæ¸›ã‚‰ã—ï¼ˆç›®å®‰ï¼š5cmï¼‰
    const toeRows = Math.max(1, Math.round(5 * rowsPerCm));

    // ãƒãƒæ‹¾ã„ç›®ï¼ˆæ¨™æº–ã®ã‚¬ã‚¼ãƒƒãƒˆã®ç›®å®‰ï¼‰
    const gussetPickup = Math.round(heelFlapRows / 2);

    // ã‚¦ãƒ„ãƒœè¨­å®š
    const utsuboSuggested = suggestUtsuboParams(totalSt);
    let utsuboGussetPerSide = 0;
    let utsuboDoublePerSide = 0;
    if (isUtsubo){
      utsuboGussetPerSide = parseInt($('utsuboGussetPerSide').value,10);
      utsuboDoublePerSide = parseInt($('utsuboDoublePerSide').value,10);
      if (!Number.isFinite(utsuboGussetPerSide) || utsuboGussetPerSide<=0){
        utsuboGussetPerSide = utsuboSuggested.gussetPerSide;
        $('utsuboGussetPerSide').value = String(utsuboGussetPerSide);
      }
      if (!Number.isFinite(utsuboDoublePerSide) || utsuboDoublePerSide<=0){
        utsuboDoublePerSide = utsuboSuggested.doublePerSide;
        $('utsuboDoublePerSide').value = String(utsuboDoublePerSide);
      }
      $('utsuboAutoHint').textContent = `ç›®å®‰ï¼šãƒãƒç‰‡å´${utsuboSuggested.gussetPerSide}ç›®ï¼ãƒ€ãƒ–ãƒ«ç›®ç‰‡å´${utsuboSuggested.doublePerSide}å›`;
    } else {
      $('utsuboAutoHint').textContent = '';
    }

    // summary
    $('summary').innerHTML = [
      `ç³¸ï¼š${gStd.name}`,
      `ã‚²ãƒ¼ã‚¸ï¼š10cm=${stitches10}ç›®Ã—${rows10}æ®µ${useCustom?'(å®Ÿæ¸¬)':''}`,
      `å½¢ï¼š${isUtsubo?'ã‚¦ãƒ„ãƒœï¼ˆãƒãƒï¼‹ãƒ€ãƒ–ãƒ«ç›®ï¼‰':'æ¨™æº–'}`,
      `ç·¨ã¿æ–¹ï¼š${method==='toe'?'ã¤ã¾å…ˆã‹ã‚‰':'å±¥ãå£ã‹ã‚‰'}`,
      `ä½œã‚Šç›®ï¼š${totalSt}ç›®`
    ].map(s=>`<span>${s}</span>`).join('');

    const steps = [];

    if (method==='toe'){
      steps.push({
        t:'1. ã¤ã¾å…ˆ',
        b:[`ä½œã‚Šç›®ï¼š<span class="big">${toeCastOnStart}ç›®</span>ï¼ˆå¶æ•°ï¼‰ã‹ã‚‰é–‹å§‹`, `å¢—ã—ç›®æ®µæ•°ï¼š<span class="big">ç´„${toeRows}æ®µ</span>ï¼ˆç›®æ¨™ï¼š${totalSt}ç›®ï¼‰`]
      });

      steps.push({
        t:'2. è¶³ã®ç”²',
        b:[`ç›®æ•°ï¼š<span class="big">${totalSt}ç›®</span>`, `æ®µæ•°ï¼š<span class="big">ç´„${footRows}æ®µ</span>ï¼ˆç´„<span class="big">${footCm}cm</span>ï¼‰`]
      });

      if (!isUtsubo){
        steps.push({
          t:'3. ã‹ã‹ã¨',
          b:[`ã‹ã‹ã¨ç›®æ•°ï¼š<span class="big">${heelStitches}ç›®</span>`, `ã‚·ãƒ§ãƒ¼ãƒˆãƒ­ã‚¦ï¼š<span class="big">ç´„${heelTurnRows}æ®µ</span>`]
        });
        steps.push({
          t:'4. é•·ã•ï¼ˆå±¥ãå£ï¼‰',
          b:[`ç›®æ•°ï¼š<span class="big">${totalSt}ç›®</span>`, `æ®µæ•°ï¼š<span class="big">ç´„${cuffRows}æ®µ</span>ï¼ˆç´„<span class="big">${cuffCm}cm</span>ï¼‰`, `<span class="muted">â€»ã‚´ãƒ ç·¨ã¿ãªã©ã§ç·¨ã‚“ã§ä¼ã›æ­¢ã‚</span>`]
        });
      } else {
        const gussetTotal = utsuboGussetPerSide*2;
        const heelWorkSt = heelStitches + gussetTotal;
        const doubleTotal = utsuboDoublePerSide*2;
        steps.push({
          t:'3. ãƒãƒï¼ˆã‚¬ã‚¼ãƒƒãƒˆï¼‰',
          b:[`å¢—ã—ç›®ï¼šç‰‡å´<span class="big">${utsuboGussetPerSide}ç›®</span>ï¼ˆåˆè¨ˆ<span class="big">${gussetTotal}ç›®</span>ï¼‰`, `<span class="muted">â€»å·¦å³ã§å¢—ã‚„ã—ã¦ãƒãƒã‚’ä½œã‚Šã¾ã™</span>`]
        });
        steps.push({
          t:'4. ã‹ã‹ã¨ï¼ˆãƒ€ãƒ–ãƒ«ç›®ï¼‰',
          b:[`ã‹ã‹ã¨ç¯„å›²ï¼š<span class="big">${heelWorkSt}ç›®</span>ï¼ˆã‹ã‹ã¨å´${heelStitches} + ãƒãƒ${gussetTotal}ï¼‰`, `ãƒ€ãƒ–ãƒ«ç›®ï¼šç‰‡å´<span class="big">${utsuboDoublePerSide}å›</span>ï¼ˆåˆè¨ˆ<span class="big">${doubleTotal}å€‹</span>ï¼‰`, `<span class="muted">â€»ã‹ã‹ã¨å¾Œã€ãƒãƒã¯æ¸›ã‚‰ã—ã¦${totalSt}ç›®ã«æˆ»ã—ã¾ã™</span>`]
        });
        steps.push({
          t:'5. é•·ã•ï¼ˆå±¥ãå£ï¼‰',
          b:[`ç›®æ•°ï¼š<span class="big">${totalSt}ç›®</span>`, `æ®µæ•°ï¼š<span class="big">ç´„${cuffRows}æ®µ</span>ï¼ˆç´„<span class="big">${cuffCm}cm</span>ï¼‰`, `<span class="muted">â€»ã‚´ãƒ ç·¨ã¿ãªã©ã§ç·¨ã‚“ã§ä¼ã›æ­¢ã‚</span>`]
        });
      }
    } else {
      steps.push({
        t:'1. é•·ã•ï¼ˆå±¥ãå£ï¼‰ãƒ»è¶³é¦–',
        b:[`ä½œã‚Šç›®ï¼š<span class="big">${totalSt}ç›®</span>`, `æ®µæ•°ï¼š<span class="big">ç´„${cuffRows}æ®µ</span>ï¼ˆç´„<span class="big">${cuffCm}cm</span>ï¼‰`, `<span class="muted">â€»ã‚´ãƒ ç·¨ã¿ãªã©ã§ç·¨ã¿ã¾ã™</span>`]
      });

      if (!isUtsubo){
        steps.push({
          t:'2. ã‹ã‹ã¨',
          b:[`ã‹ã‹ã¨ãƒ•ãƒ©ãƒƒãƒ—ï¼š<span class="big">${heelStitches}ç›® Ã— ${heelFlapRows}æ®µ</span>`, `ã‹ã‹ã¨ã‚¿ãƒ¼ãƒ³ï¼š<span class="big">ç´„${heelTurnRows}æ®µ</span>`, `<span class="muted">â€»å¾€å¾©ç·¨ã¿</span>`]
        });
        steps.push({
          t:'3. ãƒãƒï¼ˆã‚¬ã‚¼ãƒƒãƒˆï¼‰',
          b:[`æ‹¾ã„ç›®ï¼šä¸¡ç«¯ã‹ã‚‰å„<span class="big">${gussetPickup}ç›®</span>`, `<span class="muted">â€»æ¸›ã‚‰ã—ç›®ã§å…ƒã®ç›®æ•°ã«æˆ»ã—ã¾ã™</span>`]
        });
      } else {
        const gussetTotal = utsuboGussetPerSide*2;
        const heelWorkSt = heelStitches + gussetTotal;
        const doubleTotal = utsuboDoublePerSide*2;
        steps.push({
          t:'2. ã‹ã‹ã¨ï¼ˆã‚¦ãƒ„ãƒœï¼šãƒãƒï¼‹ãƒ€ãƒ–ãƒ«ç›®ï¼‰',
          b:[`ãƒãƒï¼šç‰‡å´<span class="big">${utsuboGussetPerSide}ç›®</span>ï¼ˆåˆè¨ˆ<span class="big">${gussetTotal}ç›®</span>ï¼‰`, `ãƒ€ãƒ–ãƒ«ç›®ï¼šç‰‡å´<span class="big">${utsuboDoublePerSide}å›</span>ï¼ˆåˆè¨ˆ<span class="big">${doubleTotal}å€‹</span>ï¼‰`, `<span class="muted">â€»ã‹ã‹ã¨ç¯„å›²ã¯ã€Œ${heelWorkSt}ç›®ã€ãŒç›®å®‰</span>`]
        });
      }

      steps.push({
        t:`${isUtsubo?3:4}. è¶³ã®ç”²`,
        b:[`ç›®æ•°ï¼š<span class="big">${totalSt}ç›®</span>`, `æ®µæ•°ï¼š<span class="big">ç´„${footRows}æ®µ</span>ï¼ˆç´„<span class="big">${footCm}cm</span>ï¼‰`]
      });

      steps.push({
        t:`${isUtsubo?4:5}. ã¤ã¾å…ˆ`,
        b:[`æ¸›ã‚‰ã—ç›®æ®µæ•°ï¼š<span class="big">ç´„${toeRows}æ®µ</span>`, `<span class="muted">â€»ä¸¡ç«¯ã§æ¸›ã‚‰ã—ç›®ã‚’ã—ã¦é–‰ã˜ã¾ã™</span>`]
      });
    }

    $('steps').innerHTML = steps.map(s=>`<div class="step"><h3>${s.t}</h3>${s.b.map(x=>`<div>${x}</div>`).join('')}</div>`).join('');

    // store last computed for bug report
    window.__lastDebug = {
      VERSION,
      device: navigator.userAgent,
      inputs: {footLength, ankleCirc, cuffLength, yarnWeight, useCustom, stitches10, rows10, method, sockType, totalSt},
      derived: {toeCastOnStart, footRows, footCm, cuffRows, cuffCm, toeRows, heelStitches, heelFlapRows, heelTurnRows, gussetPickup, utsuboGussetPerSide, utsuboDoublePerSide}
    };

    setGaugeHint();
  }

</script>
<script>
  // separate script block so we can keep python-free in above
  async function copyBugReport(){
    const d = window.__lastDebug || null;
    const msgEl = document.getElementById('copyMsg');
    if (!d){
      msgEl.textContent = 'å…ˆã«ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
      return;
    }
    const lines = [];
    lines.push(`[é´ä¸‹ç·¨ã¿è¨ˆç®—æ©Ÿ] ${d.VERSION}`);
    lines.push(`ç«¯æœ«ï¼š${d.device}`);
    lines.push('--- å…¥åŠ› ---');
    for (const [k,v] of Object.entries(d.inputs)) lines.push(`${k}: ${v}`);
    lines.push('--- è¨ˆç®— ---');
    for (const [k,v] of Object.entries(d.derived)) lines.push(`${k}: ${v}`);
    lines.push('--- ç—‡çŠ¶ ---');
    lines.push('ã“ã“ã«ã€Œä½•ã‚’ã—ãŸã‚‰ã©ã†ãªã£ãŸã‹ã€ã‚’1ã€œ2è¡Œã§æ›¸ã„ã¦ãã ã•ã„');
    const text = lines.join('\n');

    try{
      await navigator.clipboard.writeText(text);
      msgEl.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚LINE/DMã«è²¼ã‚Šä»˜ã‘ã¦é€ã£ã¦ãã ã•ã„ã€‚';
    } catch(e){
      // fallback
      window.prompt('ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯ã€ã“ã“ã‚’é•·æŠ¼ã—ã—ã¦å…¨é¸æŠâ†’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', text);
      msgEl.textContent = 'ã‚³ãƒ”ãƒ¼ã§ããªã„ç«¯æœ«ãªã®ã§ã€è¡¨ç¤ºã•ã‚ŒãŸå†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚';
    }
  }

  function safeCompute(){
    try{
      clearError();
      compute();
    } catch(e){
      showError(e);
    }
  }

  function init(){
    document.getElementById('versionBadge').textContent = VERSION;
    document.getElementById('useCustom').addEventListener('change', ()=>{
      document.getElementById('customBox').classList.toggle('hide', !document.getElementById('useCustom').checked);
      setGaugeHint();
      safeCompute();
    });
    document.getElementById('yarnWeight').addEventListener('change', ()=>{ setGaugeHint(); safeCompute(); });
    document.querySelectorAll('input[name="sockType"]').forEach(el=>el.addEventListener('change', ()=>{ toggleUtsuboSettings(); safeCompute(); }));
    document.querySelectorAll('input[name="method"]').forEach(el=>el.addEventListener('change', ()=>safeCompute()));

    ['footLength','ankleCirc','cuffLength','gSt','gRow','utsuboGussetPerSide','utsuboDoublePerSide'].forEach(id=>{
      const el=document.getElementById(id);
      // å…¥åŠ›ä¸­ã¯é‡ããªã‚‰ãªã„ã‚ˆã†ã«å³è¨ˆç®—ã—ãªã„ã€‚é›¢ã—ãŸã‚‰è¨ˆç®—ã€‚
      if (el) el.addEventListener('change', ()=>safeCompute());
    });

    const btn = document.getElementById('calcBtn');
    // click ãŒåŠ¹ã‹ãªã„ç«¯æœ«ãŒã‚ã‚‹ã®ã§å¤šé‡ã«æ‹¾ã†
    btn.addEventListener('click', function(e){ e.preventDefault(); safeCompute(); });
    btn.addEventListener('touchend', function(e){ e.preventDefault(); safeCompute(); }, {passive:false});
    btn.addEventListener('pointerup', function(e){ e.preventDefault(); safeCompute(); });

    document.getElementById('copyBugBtn').addEventListener('click', copyBugReport);

    toggleUtsuboSettings();
    setGaugeHint();
    safeCompute();
  }

  init();
</script>
</body>
</html>
